<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Talonario de Rifas</title>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Arial', sans-serif;
    }
    .container {
      max-width: 1200px;
      margin-top: 30px;
    }
    .header {
      background-color: #0003a7ee;
      color: white;
      padding: 20px;
      border-radius: 20px 20px 0 0;
      margin-bottom: 0;
    }
    .card {
      border-radius: 20px;
      box-shadow: 0 4px 6px rgba(228, 131, 131, 0.1);
      width: 100%;
    }
    .form-section {
      padding: 20px;
    }
    .actions-section {
      padding: 20px;
      background-color: #f1f1f1;
      border-radius: 0 0 5px 5px;
    }
    .btn-action {
      margin-right: 10px;
      min-width: 200px;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #6c757d;
      font-size: 0.9em;
    }

    /* Estilos para la segunda pantalla */
    .ticket-container {
      display: none;
      margin-top: 30px;
    }
    .info-section {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Estilos para el sistema de boletas */
    .tickets-section {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .tickets-grid-container {
      width: 100%;
      overflow-x: auto;
      padding: 15px 0;
    }
    
    .tickets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 10px;
      margin: 0 auto;
    }
    
    .ticket {
      width: 100%;
      aspect-ratio: 1/1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #0d6efd;
      color: white;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9em;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: 2px solid transparent;
    }
    
    .ticket:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    
    .ticket .number {
      font-size: 1.2em;
      margin-bottom: 3px;
    }
    
    .ticket .status {
      font-size: 0.7em;
      opacity: 0.9;
      text-transform: uppercase;
    }
    
    /* Estados de las boletas */
    .ticket.available {
      background-color: #0d6efd; /* Azul - Disponible */
    }
    
    .ticket.reserved {
      background-color: #ffc107; /* Amarillo - Apartada */
      color: #212529;
    }
    
    .ticket.sold {
      background-color: #198754; /* Verde - Vendida */
    }
    
    /* Controles de estado */
    .status-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .status-btn {
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    
    .status-btn.active {
      transform: scale(1.05);
      box-shadow: 0 0 0 2px currentColor;
    }
    
    .status-btn.available {
      background-color: #0d6efd;
      color: white;
    }
    
    .status-btn.reserved {
      background-color: #ffc107;
      color: #212529;
    }
    
    .status-btn.sold {
      background-color: #198754;
      color: white;
    }
    
    /* Estilos para la información y resumen */
    .info-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .info-box, .summary-box {
      flex: 1;
      min-width: 300px;
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .info-box h4, .summary-box h5 {
      margin-bottom: 15px;
      color: #0003a7ee;
    }
    
    .info-box p, .summary-box p {
      margin-bottom: 8px;
    }
    
    .money-summary {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
      border-left: 4px solid #0003a7ee;
    }
    
    .money-summary p {
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .money-summary .amount {
      color: #198754;
      font-size: 1.1em;
    }
    
      .money-summary .pendiente {
      color: #ff0000;
      font-size: 1.1em;
    }

    /* Estilos responsivos */
    @media (max-width: 768px) {
      .tickets-grid {
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      }
      
      .ticket .number {
        font-size: 1em;
      }
      
      .info-box, .summary-box {
        min-width: 100%;
      }
    }
    
    .form-control:invalid {
      border-color: #dc3545;
    }
    
    .form-control:valid {
      border-color: #198754;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Primera pantalla - Formulario -->
    <div class="card" id="formScreen">
      <h1 class="header text-center">TALONARIO DE RIFAS</h1>
      
      <div class="form-section">
        <h3>Información del Talonario</h3>
        <h5 class="mb-4">CONFIGURA TU TALONARIO</h5>
        
        <form id="raffleForm">
          <div class="mb-3">
            <label for="prize" class="form-label">Premio de la rifa</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" id="prize" placeholder="Ingrese el premio" required min="1">
            </div>
          </div>
          
          <div class="mb-3">
            <label for="ticketPrice" class="form-label">Valor de la boleta</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" id="ticketPrice" placeholder="Ingrese valor de la boleta" required min="1">
            </div>
          </div>
          
          <div class="mb-3">
            <label for="lottery" class="form-label">Seleccione la lotería</label>
            <select class="form-select" id="lottery" required>
              <option value="" selected disabled>Seleccione una opción</option>
              <option value="cruz_roja">Cruz Roja</option>
              <option value="la_perla">La Perla</option>
              <option value="baloto_santander">Baloto Santander</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="ticketCount" class="form-label">Cantidad de Boletas</label>
            <input type="number" class="form-control" id="ticketCount" placeholder="Ingrese la cantidad" required min="1" max="100">
          </div>
          
          <div class="mb-4">
            <label for="date" class="form-label">Fecha del sorteo</label>
            <input type="date" class="form-control" id="date" required>
          </div>
          
          <button type="submit" class="btn btn-primary" id="saveBtn" disabled>Guardar</button>
        </form>
      </div>
    </div>
    
    <!-- Segunda pantalla - Información del talonario -->
    <div class="ticket-container" id="ticketScreen">
      <div class="card">
        <h1 class="header text-center">TALONARIO DE RIFAS</h1>
        
        <div class="p-4">
          <!-- Sección superior: Información y resumen -->
          <div class="info-summary">
            <div class="info-box">
              <h4>Información del Talonario</h4>
              <p><strong>Premio:</strong> <span id="displayPrize"></span></p>
              <p><strong>Valor boleta:</strong> <span id="displayPrice"></span></p>
              <p><strong>Lotería:</strong> <span id="displayLottery"></span></p>
              <p><strong>Cantidad boletas:</strong> <span id="displayCount"></span></p>
              <p><strong>Fecha sorteo:</strong> <span id="displayDate"></span></p>
            </div>
            
            <div class="summary-box">
              <h5>Resumen de estados</h5>
              <p><span class="badge bg-primary">Disponibles: <span id="availableCount">0</span></span></p>
              <p><span class="badge bg-warning text-dark">Apartadas: <span id="reservedCount">0</span></span></p>
              <p><span class="badge bg-success">Vendidas: <span id="soldCount">0</span></span></p>
              
              <div class="money-summary">
                <p>Dinero vendido: <span class="amount" id="moneySold">$0</span></p>
                <p>Dinero por cobrar: <span class="pendiente" id="moneyPending">$0</span></p>
              </div>
            </div>
          </div>
          
          <!-- Sección inferior: Boletas -->
          <div class="tickets-section">
            <h4 class="mb-3">Boletas del Talonario</h4>
            
            <!-- Controles de estado -->
            <div class="status-controls">
              <div class="status-btn available active" data-status="available">Disponible</div>
              <div class="status-btn reserved" data-status="reserved">Apartada</div>
              <div class="status-btn sold" data-status="sold">Vendida</div>
            </div>
            
            <!-- Grid de boletas -->
            <div class="tickets-grid-container">
              <div class="tickets-grid" id="numbersGrid"></div>
            </div>
          </div>
        </div>
        
        <!-- Acciones -->
        <div class="actions-section">
          <div class="d-flex justify-content-center flex-wrap">
            <button id="printTickets" class="btn btn-success btn-action mb-2">
              <i class="fa fa-print"></i> IMPRIMIR BOLETAS
            </button>
            <button id="exportTickets" class="btn btn-info btn-action mb-2">
              <i class="fa fa-file-excel-o"></i> EXPORTAR A EXCEL
            </button>
            <button id="newRaffle" class="btn btn-warning btn-action mb-2">
              <i class="fa fa-plus"></i> NUEVO TALONARIO
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      Copyright ©2024. Sistema de Talonarios de Rifas
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  
  <script>
    // Variables globales
    let raffleInfo = {};
    let tickets = [];
    let currentStatus = 'available';
    
    // Cargar datos del localStorage al iniciar
    document.addEventListener('DOMContentLoaded', function() {
      const savedData = localStorage.getItem('raffleInfo');
      if (savedData) {
        const data = JSON.parse(savedData);
        raffleInfo = data.info || {};
        tickets = data.tickets || [];
        
        // Rellenar el formulario con los datos guardados
        document.getElementById('prize').value = raffleInfo.prize || '';
        document.getElementById('ticketPrice').value = raffleInfo.ticketPrice || '';
        document.getElementById('lottery').value = raffleInfo.lottery || '';
        document.getElementById('ticketCount').value = raffleInfo.ticketCount || '';
        document.getElementById('date').value = raffleInfo.date || '';
        
        // Validar el botón de guardar
        document.getElementById('saveBtn').disabled = !document.getElementById('raffleForm').checkValidity();
        
        // Si ya hay datos guardados, mostrar directamente la pantalla del talonario
        if (raffleInfo.prize) {
          document.getElementById('formScreen').style.display = 'none';
          document.getElementById('ticketScreen').style.display = 'block';
          displayRaffleInfo();
          generateTicketNumbers();
          updateCounters();
          updateMoneySummary();
        }
      }
      
      // Configurar controles de estado
      setupStatusControls();
    });
    
    // Configurar controles de estado
    function setupStatusControls() {
      const statusBtns = document.querySelectorAll('.status-btn');
      statusBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          statusBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentStatus = this.dataset.status;
        });
      });
    }
    
    // Validar formulario en tiempo real
    document.getElementById('raffleForm').addEventListener('input', function() {
      const form = this;
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = !form.checkValidity();
    });
    
    // Manejar el envío del formulario
    document.getElementById('raffleForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Almacenar la información
      raffleInfo = {
        prize: document.getElementById('prize').value,
        ticketPrice: document.getElementById('ticketPrice').value,
        lottery: document.getElementById('lottery').value,
        ticketCount: document.getElementById('ticketCount').value,
        date: document.getElementById('date').value
      };
      
      // Inicializar las boletas
      tickets = [];
      const count = parseInt(raffleInfo.ticketCount);
      for (let i = 1; i <= count; i++) {
        tickets.push({
          number: i,
          status: 'available',
          client: ''
        });
      }
      
      // Guardar en localStorage
      saveToLocalStorage();
      
      // Mostrar mensaje de éxito
      Swal.fire({
        title: '¡Talonario creado!',
        text: 'El talonario ha sido configurado correctamente.',
        icon: 'success'
      }).then(() => {
        // Ocultar formulario y mostrar pantalla de talonario
        document.getElementById('formScreen').style.display = 'none';
        document.getElementById('ticketScreen').style.display = 'block';
        
        // Mostrar la información guardada
        displayRaffleInfo();
        
        // Generar números de boletas
        generateTicketNumbers();
        
        // Actualizar contadores
        updateCounters();
        updateMoneySummary();
      });
    });
    
    // Mostrar la información del talonario
    function displayRaffleInfo() {
      document.getElementById('displayPrize').textContent = '$' + raffleInfo.prize;
      document.getElementById('displayPrice').textContent = '$' + raffleInfo.ticketPrice;
      
      let lotteryName = '';
      switch(raffleInfo.lottery) {
        case 'cruz_roja': lotteryName = 'Cruz Roja'; break;
        case 'la_perla': lotteryName = 'La Perla'; break;
        case 'baloto_santander': lotteryName = 'Baloto Santander'; break;
      }
      document.getElementById('displayLottery').textContent = lotteryName;
      
      document.getElementById('displayCount').textContent = raffleInfo.ticketCount;
      document.getElementById('displayDate').textContent = raffleInfo.date;
    }
    
    // Generar números de boletas
    function generateTicketNumbers() {
      const numbersGrid = document.getElementById('numbersGrid');
      numbersGrid.innerHTML = '';
      
      tickets.forEach(ticket => {
        const ticketElement = document.createElement('div');
        ticketElement.className = `ticket ${ticket.status}`;
        ticketElement.dataset.number = ticket.number;
        
        ticketElement.innerHTML = `
          <div class="number">${ticket.number.toString().padStart(3, '0')}</div>
          <div class="status">${getStatusText(ticket.status)}</div>
        `;
        
        ticketElement.addEventListener('click', function() {
          const ticketNumber = parseInt(this.dataset.number);
          const ticketIndex = tickets.findIndex(t => t.number === ticketNumber);
          
          if (ticketIndex !== -1) {
            // Cambiar el estado según la selección actual
            tickets[ticketIndex].status = currentStatus;
            
            // Actualizar la visualización
            this.className = `ticket ${currentStatus}`;
            this.querySelector('.status').textContent = getStatusText(currentStatus);
            
            // Guardar cambios y actualizar contadores
            saveToLocalStorage();
            updateCounters();
            updateMoneySummary();
          }
        });
        
        numbersGrid.appendChild(ticketElement);
      });
    }
    
    // Obtener texto descriptivo del estado
    function getStatusText(status) {
      switch(status) {
        case 'available': return 'Disponible';
        case 'reserved': return 'Apartada';
        case 'sold': return 'Vendida';
        default: return '';
      }
    }
    
    // Actualizar contadores de estados
    function updateCounters() {
      const available = tickets.filter(t => t.status === 'available').length;
      const reserved = tickets.filter(t => t.status === 'reserved').length;
      const sold = tickets.filter(t => t.status === 'sold').length;
      
      document.getElementById('availableCount').textContent = available;
      document.getElementById('reservedCount').textContent = reserved;
      document.getElementById('soldCount').textContent = sold;
    }
    
    // Actualizar resumen de dinero
    function updateMoneySummary() {
      const ticketPrice = parseFloat(raffleInfo.ticketPrice) || 0;
      const reserved = tickets.filter(t => t.status === 'reserved').length;
      const sold = tickets.filter(t => t.status === 'sold').length;
      
      const moneySold = sold * ticketPrice;
      const moneyPending = reserved * ticketPrice;
      
      document.getElementById('moneySold').textContent = '$' + moneySold.toLocaleString('es-ES');
      document.getElementById('moneyPending').textContent = '$' + moneyPending.toLocaleString('es-ES');
    }
    
    // Guardar datos en localStorage
    function saveToLocalStorage() {
      localStorage.setItem('raffleInfo', JSON.stringify({
        info: raffleInfo,
        tickets: tickets
      }));
    }
    
    // Botón para crear nuevo talonario
    document.getElementById('newRaffle').addEventListener('click', function() {
      Swal.fire({
        title: '¿Crear nuevo talonario?',
        text: 'Se perderán los datos del talonario actual',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, crear nuevo',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          // Limpiar el localStorage
          localStorage.removeItem('raffleInfo');
          
          document.getElementById('ticketScreen').style.display = 'none';
          document.getElementById('formScreen').style.display = 'block';
          document.getElementById('raffleForm').reset();
          document.getElementById('saveBtn').disabled = true;
        }
      });
    });
    
    // Botones de acciones (simulados)
    document.getElementById('printTickets').addEventListener('click', function() {
      Swal.fire('Impresión', 'Las boletas se enviarán a impresión.', 'info');
    });
    
    document.getElementById('exportTickets').addEventListener('click', function() {
      Swal.fire('Exportar', 'Los datos se exportarán a Excel.', 'info');
    });
  </script>
</body>
</html>